{
  "name": "Fleet TCO Calculator",
  "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide",
  "version": "2.0.0",
  "items": [{
    "url": "tco.html",
    "path": "ActivityLink",
    "menuName": {
      "en": "Fleet TCO Calculator"
    }
  }],
  "files": {
    "tco.html": "<!DOCTYPE html><html><head><meta charset='utf-8'></head><body style='margin:0;padding:0;font-family:sans-serif;background:#f4f7f6;'><script>var link=document.createElement('link');link.rel='stylesheet';link.href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css';document.head.appendChild(link);</script><div style='background:#002b49;padding:15px;display:flex;align-items:center;justify-content:space-between;border-bottom:4px solid #00a1de;'><h2 style='color:#fff;margin:0;font-size:18px;'>FLEET TCO CALCULATOR</h2><select id='dateRange' class='form-select form-select-sm' style='width:180px;'><option value='30' selected>Last 30 Days</option><option value='60'>Last 60 Days</option><option value='90'>Last 90 Days</option><option value='month'>This Month</option><option value='year'>This Year</option><option value='lastYear'>Last Year</option></select></div><div class='container-fluid p-3'><div class='row g-3 mb-3'><div class='col-md-4'><div class='card shadow-sm border-0'><div class='card-body'><h6>Fleet Summary</h6><div class='row text-center'><div class='col-6'><small>MILES</small><div id='sum-miles' class='fw-bold'>0</div></div><div class='col-6'><small>TCO</small><div id='sum-tco' class='fw-bold' style='color:#002b49;'>$0</div></div></div></div></div></div><div class='col-md-8'><div class='card shadow-sm border-0'><div class='card-body'><h6>Bulk Classification</h6><div class='btn-group btn-group-sm w-100'><button onclick=\"bulkSet('L')\" class='btn btn-outline-dark'>Set All Light</button><button onclick=\"bulkSet('M')\" class='btn btn-outline-dark'>Set All Medium</button><button onclick=\"bulkSet('H')\" class='btn btn-outline-dark'>Set All Heavy</button></div></div></div></div></div><div class='card shadow-sm border-0 mb-3'><div class='card-body p-0'><div class='table-responsive'><table class='table table-hover align-middle mb-0' style='font-size:12px;'><thead><tr style='background:#eee;'><th>VEHICLE</th><th>YEAR/MAKE/MODEL</th><th>CLASS</th><th>MILES</th><th class='text-end'>TCO</th></tr></thead><tbody id='tco-body'></tbody></table></div><div id='loading' style='padding:20px;text-align:center;'>Calculating...</div></div></div><div class='card shadow-sm border-0'><div class='card-body'><h6>Class Parameters</h6><div class='table-responsive'><table class='table table-sm table-bordered' style='font-size:11px;'><thead><tr><th>Class</th><th>Price ($)</th><th>Residual ($)</th><th>Life (Yr)</th><th>Fuel ($/G)</th><th>Maint ($/M)</th></tr></thead><tbody><tr><td><b>Light</b></td><td><input type='number' id='L_p' class='form-control form-control-sm' value='45000'></td><td><input type='number' id='L_r' class='form-control form-control-sm' value='10000'></td><td><input type='number' id='L_y' class='form-control form-control-sm' value='5'></td><td><input type='number' id='L_f' class='form-control form-control-sm' value='4.25'></td><td><input type='number' id='L_m' class='form-control form-control-sm' value='0.12'></td></tr><tr><td><b>Medium</b></td><td><input type='number' id='M_p' class='form-control form-control-sm' value='85000'></td><td><input type='number' id='M_r' class='form-control form-control-sm' value='20000'></td><td><input type='number' id='M_y' class='form-control form-control-sm' value='7'></td><td><input type='number' id='M_f' class='form-control form-control-sm' value='4.50'></td><td><input type='number' id='M_m' class='form-control form-control-sm' value='0.25'></td></tr><tr><td><b>Heavy</b></td><td><input type='number' id='H_p' class='form-control form-control-sm' value='165000'></td><td><input type='number' id='H_r' class='form-control form-control-sm' value='45000'></td><td><input type='number' id='H_y' class='form-control form-control-sm' value='10'></td><td><input type='number' id='H_f' class='form-control form-control-sm' value='4.75'></td><td><input type='number' id='H_m' class='form-control form-control-sm' value='0.45'></td></tr></tbody></table></div><button id='saveBtn' class='btn btn-sm w-100 text-white mt-2' style='background:#002b49;'>RECALCULATE ALL</button></div></div></div><script>var _db={};var _classMap={};var _api;var S_ID='fleet_tco_calculator';function bulkSet(c){var ids=Object.keys(_db);for(var i=0;i<ids.length;i++){_classMap[ids[i]]=c;}saveMapping();}function updateClass(deviceId,cls){_classMap[deviceId]=cls;saveMapping();}function saveMapping(){_api.call('Add',{typeName:'AddInData',entity:{addInId:S_ID,details:{map:_classMap}}},function(){refresh(_api);});}function getParameters(){return{L:{p:parseFloat(document.getElementById('L_p').value),r:parseFloat(document.getElementById('L_r').value),y:parseFloat(document.getElementById('L_y').value),f:parseFloat(document.getElementById('L_f').value),m:parseFloat(document.getElementById('L_m').value)},M:{p:parseFloat(document.getElementById('M_p').value),r:parseFloat(document.getElementById('M_r').value),y:parseFloat(document.getElementById('M_y').value),f:parseFloat(document.getElementById('M_f').value),m:parseFloat(document.getElementById('M_m').value)},H:{p:parseFloat(document.getElementById('H_p').value),r:parseFloat(document.getElementById('H_r').value),y:parseFloat(document.getElementById('H_y').value),f:parseFloat(document.getElementById('H_f').value),m:parseFloat(document.getElementById('H_m').value)}};}function getDates(val){var now=new Date();var start=new Date();var end=new Date();if(val==='30')start.setDate(now.getDate()-30);else if(val==='60')start.setDate(now.getDate()-60);else if(val==='90')start.setDate(now.getDate()-90);else if(val==='month'){start=new Date(now.getFullYear(),now.getMonth(),1);}else if(val==='year'){start=new Date(now.getFullYear(),0,1);}else if(val==='lastYear'){start=new Date(now.getFullYear()-1,0,1);end=new Date(now.getFullYear()-1,11,31,23,59,59);}return{from:start.toISOString(),to:end.toISOString()};}function refresh(api){_api=api;var dates=getDates(document.getElementById('dateRange').value);api.multiCall([['Get',{typeName:'Device'}],['Get',{typeName:'Trip',search:{fromDate:dates.from,toDate:dates.to}}]],function(results){var devices=results[0];var trips=results[1];_db={};devices.forEach(function(device){var cls=_classMap[device.id]||'L';_db[device.id]={id:device.id,name:device.name,info:(device.year||'')+' '+(device.make||'')+' '+(device.model||''),cls:cls,mi:0};});trips.forEach(function(trip){if(_db[trip.device.id]){_db[trip.device.id].mi+=(trip.distance||0)*0.621371;}});render();},function(error){console.error('TCO Calculator: multiCall failed',error);document.getElementById('loading').textContent='Error loading data. Check console.';});api.call('Get',{typeName:'AddInData',search:{addInId:S_ID}},function(stored){if(stored&&stored.length>0){_classMap=stored[0].details.map||{};}},function(){console.log('TCO Calculator: No saved class mappings found, using defaults');});}function render(){var params=getParameters();var tbody=document.getElementById('tco-body');tbody.innerHTML='';var totalMiles=0;var totalTco=0;var ids=Object.keys(_db);for(var i=0;i<ids.length;i++){var vehicle=_db[ids[i]];var cp=params[vehicle.cls];var depreciation=((cp.p-cp.r)/cp.y)/12;var fuelCost=vehicle.mi*0.1*cp.f;var maintCost=vehicle.mi*cp.m;var vehicleTco=depreciation+fuelCost+maintCost;totalMiles+=vehicle.mi;totalTco+=vehicleTco;var tr=document.createElement('tr');tr.innerHTML='<td>'+vehicle.name+'</td><td>'+vehicle.info+'</td><td><select onchange=\"updateClass(\\''+vehicle.id+'\\', this.value)\" class=\"form-select form-select-sm\"><option value=\"L\"'+(vehicle.cls==='L'?' selected':'')+'>Light</option><option value=\"M\"'+(vehicle.cls==='M'?' selected':'')+'>Medium</option><option value=\"H\"'+(vehicle.cls==='H'?' selected':'')+'>Heavy</option></select></td><td>'+vehicle.mi.toFixed(0)+'</td><td class=\"text-end fw-bold\">$'+vehicleTco.toFixed(2)+'</td>';tbody.appendChild(tr);}document.getElementById('sum-miles').textContent=Math.round(totalMiles).toLocaleString();document.getElementById('sum-tco').textContent='$'+Math.round(totalTco).toLocaleString();document.getElementById('loading').style.display='none';}geotab.addin['fleet-tco-calc']=function(){return{initialize:function(api,state,callback){document.getElementById('saveBtn').onclick=function(){refresh(api);};document.getElementById('dateRange').onchange=function(){refresh(api);};refresh(api);callback();},focus:function(api){refresh(api);}};};</script></body></html>"
  }
}
