{
  "name": "Ace vs API Comparison",
  "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide",
  "version": "1.4",
  "items": [
    {
      "url": "page.html",
      "path": "ActivityLink",
      "menuName": {
        "en": "Ace vs API Comparison"
      }
    }
  ],
  "files": {
    "page.html": "<!DOCTYPE html>\n<html>\n<head>\n    <meta charset='utf-8'>\n    <meta name='viewport' content='width=device-width, initial-scale=1'>\n    <title>Ace vs API Comparison</title>\n    <style>\n        body {\n            padding: 20px;\n            font-family: system-ui, -apple-system, sans-serif;\n            background: #f8fafc;\n            color: #1e293b;\n            max-width: 1400px;\n            margin: 0 auto;\n        }\n        h1 {\n            color: #0f172a;\n            margin-bottom: 4px;\n        }\n        .subtitle {\n            color: #64748b;\n            margin-top: 0;\n            margin-bottom: 24px;\n        }\n        .grid {\n            display: flex;\n            flex-direction: column;\n            gap: 16px;\n        }\n        @media (min-width: 1200px) {\n            .grid {\n                display: grid;\n                grid-template-columns: repeat(3, 1fr);\n            }\n        }\n        .card {\n            background: #fff;\n            padding: 16px;\n            border-radius: 10px;\n            border: 1px solid #e2e8f0;\n            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        }\n        .card-header {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            margin-bottom: 12px;\n            border-bottom: 1px solid #f1f5f9;\n            padding-bottom: 12px;\n        }\n        .card-header h3 {\n            margin: 0;\n            font-size: 14px;\n            color: #0f172a;\n        }\n        .card-header p {\n            margin: 0;\n            font-size: 11px;\n            color: #64748b;\n        }\n        .emoji {\n            font-size: 20px;\n        }\n        .question-box {\n            background: #f0f9ff;\n            border: 1px solid #bae6fd;\n            border-radius: 6px;\n            padding: 10px;\n            margin-bottom: 12px;\n        }\n        .question-box .label {\n            font-size: 10px;\n            color: #0369a1;\n            font-weight: 600;\n            margin-bottom: 4px;\n        }\n        .question-box .api-q {\n            font-size: 11px;\n            color: #166534;\n            margin: 4px 0;\n            font-family: ui-monospace, monospace;\n        }\n        .question-box .ace-q {\n            font-size: 11px;\n            color: #a16207;\n            margin: 4px 0;\n            font-style: italic;\n        }\n        .results-grid {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 8px;\n        }\n        .api-result {\n            background: #f0fdf4;\n            padding: 10px;\n            border-radius: 6px;\n            border: 1px solid #bbf7d0;\n        }\n        .api-result .label {\n            font-size: 10px;\n            color: #166534;\n            font-weight: 600;\n            margin-bottom: 4px;\n        }\n        .api-result .value {\n            font-size: 18px;\n            font-weight: bold;\n            color: #15803d;\n        }\n        .api-result .status {\n            font-size: 10px;\n            color: #166534;\n        }\n        .ace-result {\n            background: #fefce8;\n            padding: 10px;\n            border-radius: 6px;\n            border: 1px solid #fef08a;\n        }\n        .ace-result .label {\n            font-size: 10px;\n            color: #a16207;\n            font-weight: 600;\n            margin-bottom: 4px;\n        }\n        .ace-result .value {\n            font-size: 18px;\n            font-weight: bold;\n            color: #ca8a04;\n        }\n        .ace-result .status {\n            font-size: 10px;\n            color: #a16207;\n        }\n        .ace-result.waiting {\n            opacity: 0.6;\n        }\n        .debug {\n            font-size: 9px;\n            margin: 8px 0 0 0;\n            background: #f1f5f9;\n            padding: 6px;\n            border-radius: 4px;\n            overflow: auto;\n            max-height: 120px;\n            font-family: ui-monospace, monospace;\n            white-space: pre-wrap;\n            word-break: break-word;\n        }\n        .debug-ace {\n            background: #fef3c7;\n        }\n        .log-section {\n            margin-top: 20px;\n            background: #fff;\n            padding: 16px;\n            border-radius: 10px;\n            border: 1px solid #e2e8f0;\n        }\n        .log-section h3 {\n            margin: 0 0 12px 0;\n            font-size: 14px;\n            color: #0f172a;\n        }\n        #log {\n            background: #f8fafc;\n            padding: 10px;\n            border-radius: 6px;\n            max-height: 200px;\n            overflow: auto;\n            font-size: 10px;\n            font-family: ui-monospace, monospace;\n            color: #475569;\n        }\n        .takeaways {\n            margin-top: 16px;\n            background: #eff6ff;\n            padding: 16px;\n            border-radius: 10px;\n            border: 1px solid #bfdbfe;\n        }\n        .takeaways h3 {\n            margin: 0 0 10px 0;\n            font-size: 14px;\n            color: #1e40af;\n        }\n        .takeaways-grid {\n            display: grid;\n            grid-template-columns: 1fr;\n            gap: 12px;\n            font-size: 12px;\n        }\n        @media (min-width: 768px) {\n            .takeaways-grid {\n                grid-template-columns: repeat(3, 1fr);\n            }\n        }\n        .takeaways strong.api {\n            color: #15803d;\n        }\n        .takeaways strong.ace {\n            color: #ca8a04;\n        }\n        .takeaways strong.when {\n            color: #1e40af;\n        }\n        .takeaways ul {\n            margin: 4px 0 0 0;\n            padding-left: 16px;\n            color: #475569;\n        }\n        #t3-result {\n            max-height: 120px;\n        }\n        #t2-api-result, #t2-ace-result {\n            font-size: 11px;\n            word-break: break-word;\n        }\n        #t3-api-time, #t3-ace-time {\n            font-size: 14px;\n        }\n        .rate-limit-notice {\n            background: #fef3c7;\n            border: 1px solid #fcd34d;\n            border-radius: 6px;\n            padding: 8px 12px;\n            margin-bottom: 16px;\n            font-size: 11px;\n            color: #92400e;\n        }\n    </style>\n</head>\n<body>\n    <h1>Ace vs Direct API Comparison v1.4</h1>\n    <p class=\"subtitle\">Three tests demonstrating when to use each approach</p>\n    \n    <div class=\"rate-limit-notice\">\n        <strong>Note:</strong> Ace queries are staggered (15s apart) to avoid rate limits. API calls run immediately.\n    </div>\n\n    <div class=\"grid\">\n        <!-- Test 1: Speed -->\n        <div class=\"card\">\n            <div class=\"card-header\">\n                <span class=\"emoji\">1&#xFE0F;&#x20E3;</span>\n                <div>\n                    <h3>Speed Test</h3>\n                    <p>Same question, timing comparison</p>\n                </div>\n            </div>\n            <div class=\"question-box\">\n                <div class=\"label\">QUESTIONS ASKED</div>\n                <div class=\"api-q\">API: Get all Device objects, count length</div>\n                <div class=\"ace-q\">Ace: \"How many vehicles are in my fleet?\"</div>\n            </div>\n            <div class=\"results-grid\">\n                <div class=\"api-result\">\n                    <div class=\"label\">DIRECT API</div>\n                    <div class=\"value\" id=\"t1-api-time\">--</div>\n                    <div class=\"status\" id=\"t1-api-status\">Waiting...</div>\n                </div>\n                <div class=\"ace-result waiting\" id=\"t1-ace-box\">\n                    <div class=\"label\">ACE AI</div>\n                    <div class=\"value\" id=\"t1-ace-time\">--</div>\n                    <div class=\"status\" id=\"t1-ace-status\">Queued...</div>\n                </div>\n            </div>\n            <pre class=\"debug\" id=\"t1-debug\"></pre>\n        </div>\n\n        <!-- Test 2: Freshness -->\n        <div class=\"card\">\n            <div class=\"card-header\">\n                <span class=\"emoji\">2&#xFE0F;&#x20E3;</span>\n                <div>\n                    <h3>Freshness Test</h3>\n                    <p>Ace data can be hours behind</p>\n                </div>\n            </div>\n            <div class=\"question-box\">\n                <div class=\"label\">QUESTIONS ASKED</div>\n                <div class=\"api-q\">API: Get Trip (last 30 days), sort by stop time</div>\n                <div class=\"ace-q\">Ace: \"When was the most recent trip in my fleet? Give me the exact end time and vehicle name.\"</div>\n            </div>\n            <div class=\"results-grid\">\n                <div class=\"api-result\">\n                    <div class=\"label\">API (Real-time)</div>\n                    <div id=\"t2-api-result\">Waiting...</div>\n                </div>\n                <div class=\"ace-result waiting\" id=\"t2-ace-box\">\n                    <div class=\"label\">ACE (Historical)</div>\n                    <div id=\"t2-ace-result\">Queued...</div>\n                </div>\n            </div>\n            <pre class=\"debug\" id=\"t2-debug\"></pre>\n        </div>\n\n        <!-- Test 3: Complex Analysis -->\n        <div class=\"card\">\n            <div class=\"card-header\">\n                <span class=\"emoji\">3&#xFE0F;&#x20E3;</span>\n                <div>\n                    <h3>Complex Analysis</h3>\n                    <p>API gets raw data, Ace analyzes it</p>\n                </div>\n            </div>\n            <div class=\"question-box\">\n                <div class=\"label\">QUESTIONS ASKED</div>\n                <div class=\"api-q\">API: Get Trip (this month), aggregate by device in JS</div>\n                <div class=\"ace-q\">Ace: \"What are the top 3 vehicles by total distance traveled this month? Show vehicle name and distance in miles.\"</div>\n            </div>\n            <div class=\"results-grid\">\n                <div class=\"api-result\">\n                    <div class=\"label\">API (Raw Data)</div>\n                    <div class=\"value\" id=\"t3-api-time\">--</div>\n                    <div class=\"status\" id=\"t3-api-status\">Waiting...</div>\n                </div>\n                <div class=\"ace-result waiting\" id=\"t3-ace-box\">\n                    <div class=\"label\">ACE (Analyzed)</div>\n                    <div class=\"value\" id=\"t3-ace-time\">--</div>\n                    <div class=\"status\" id=\"t3-ace-status\">Queued...</div>\n                </div>\n            </div>\n            <pre class=\"debug\" id=\"t3-result\"></pre>\n            <pre class=\"debug debug-ace\" id=\"t3-debug\"></pre>\n        </div>\n    </div>\n\n    <div class=\"log-section\">\n        <h3>Activity Log</h3>\n        <div id=\"log\"></div>\n    </div>\n\n    <div class=\"takeaways\">\n        <h3>Key Takeaways</h3>\n        <div class=\"takeaways-grid\">\n            <div>\n                <strong class=\"api\">Direct API</strong>\n                <ul>\n                    <li>~300-500ms response</li>\n                    <li>Real-time data</li>\n                    <li>Raw data only</li>\n                </ul>\n            </div>\n            <div>\n                <strong class=\"ace\">Ace AI</strong>\n                <ul>\n                    <li>~30-90 sec response</li>\n                    <li>2-24 hours behind</li>\n                    <li>Analyzed results</li>\n                </ul>\n            </div>\n            <div>\n                <strong class=\"when\">When to Use</strong>\n                <ul>\n                    <li>API: live data, writes</li>\n                    <li>Ace: trends, insights</li>\n                    <li>Test 3: API fast but YOU aggregate</li>\n                </ul>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // Configuration\n        var ACE_STAGGER_DELAY = 15000; // 15 seconds between Ace queries to avoid rate limits\n        var ACE_INITIAL_POLL_DELAY = 10000; // Wait 10s before first poll\n        var ACE_POLL_INTERVAL = 8000; // Poll every 8s\n        var ACE_MAX_POLL_ATTEMPTS = 20; // Max polling attempts\n\n        console.log('========================================');\n        console.log('Ace vs API Comparison v1.4 initializing');\n        console.log('ACE_STAGGER_DELAY:', ACE_STAGGER_DELAY, 'ms');\n        console.log('ACE_INITIAL_POLL_DELAY:', ACE_INITIAL_POLL_DELAY, 'ms');\n        console.log('ACE_POLL_INTERVAL:', ACE_POLL_INTERVAL, 'ms');\n        console.log('ACE_MAX_POLL_ATTEMPTS:', ACE_MAX_POLL_ATTEMPTS);\n        console.log('========================================');\n\n        // Logging utilities\n        function log(m) {\n            var d = document.getElementById('log');\n            var t = new Date().toLocaleTimeString();\n            d.innerHTML = '<div>[' + t + '] ' + m + '</div>' + d.innerHTML;\n            console.log('[LOG ' + t + '] ' + m);\n        }\n\n        function debug(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n            console.log('[DEBUG ' + id + '] ' + m);\n        }\n\n        function result(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n            console.log('[RESULT ' + id + '] ' + m);\n        }\n\n        // Extract Ace data from nested response\n        function getAceData(r) {\n            console.log('[getAceData] Raw response:', JSON.stringify(r).substring(0, 500));\n            if (r && r.apiResult && r.apiResult.results) {\n                var data = r.apiResult.results[0] || {};\n                console.log('[getAceData] Extracted from apiResult.results[0]:', JSON.stringify(data).substring(0, 300));\n                return data;\n            }\n            console.log('[getAceData] Using response as-is');\n            return r || {};\n        }\n\n        // Geotab Add-In registration\n        geotab.addin['ace-api-comparison'] = function() {\n            return {\n                initialize: function(api, state, callback) {\n                    console.log('[INIT] Add-in initializing...');\n                    console.log('[INIT] API object:', typeof api);\n                    console.log('[INIT] State:', JSON.stringify(state));\n                    \n                    log('Starting comparison tests...');\n                    log('API tests run immediately, Ace tests staggered by ' + (ACE_STAGGER_DELAY/1000) + 's');\n                    \n                    // Run all API tests immediately (they're fast)\n                    console.log('[INIT] Starting API tests immediately...');\n                    runTest1Api(api);\n                    runTest2Api(api);\n                    runTest3Api(api);\n                    \n                    // Stagger Ace tests to avoid rate limits\n                    console.log('[INIT] Scheduling Ace tests with stagger...');\n                    \n                    setTimeout(function() {\n                        console.log('[INIT] Starting Test 1 Ace query...');\n                        log('Starting Ace Test 1 (speed)...');\n                        document.getElementById('t1-ace-box').classList.remove('waiting');\n                        runTest1Ace(api);\n                    }, 0);\n                    \n                    setTimeout(function() {\n                        console.log('[INIT] Starting Test 2 Ace query...');\n                        log('Starting Ace Test 2 (freshness)...');\n                        document.getElementById('t2-ace-box').classList.remove('waiting');\n                        runTest2Ace(api);\n                    }, ACE_STAGGER_DELAY);\n                    \n                    setTimeout(function() {\n                        console.log('[INIT] Starting Test 3 Ace query...');\n                        log('Starting Ace Test 3 (analysis)...');\n                        document.getElementById('t3-ace-box').classList.remove('waiting');\n                        runTest3Ace(api);\n                    }, ACE_STAGGER_DELAY * 2);\n                    \n                    callback();\n                },\n                focus: function() {\n                    console.log('[FOCUS] Add-in focused');\n                },\n                blur: function() {\n                    console.log('[BLUR] Add-in blurred');\n                }\n            };\n        };\n\n        // Test 1: Speed comparison - API part\n        function runTest1Api(api) {\n            console.log('[T1-API] Starting speed test API call...');\n            var apiStart = Date.now();\n            document.getElementById('t1-api-status').textContent = 'Fetching...';\n\n            console.log('[T1-API] Calling Get Device...');\n            api.call('Get', { typeName: 'Device' }, function(devices) {\n                var t = Date.now() - apiStart;\n                console.log('[T1-API] SUCCESS - Got', devices.length, 'devices in', t, 'ms');\n                console.log('[T1-API] First device sample:', JSON.stringify(devices[0]).substring(0, 200));\n                \n                document.getElementById('t1-api-time').textContent = t + 'ms';\n                document.getElementById('t1-api-status').textContent = devices.length + ' vehicles';\n                debug('t1-debug', 'API: ' + devices.length + ' Device objects in ' + t + 'ms');\n                log('Test1 API: ' + devices.length + ' devices in ' + t + 'ms');\n            }, function(e) {\n                console.error('[T1-API] ERROR:', e);\n                document.getElementById('t1-api-status').textContent = 'Error';\n                debug('t1-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        // Test 1: Speed comparison - Ace part\n        function runTest1Ace(api) {\n            var question = 'How many vehicles are in my fleet?';\n            console.log('[T1-ACE] Starting speed test Ace query...');\n            console.log('[T1-ACE] Question:', question);\n            \n            var aceStart = Date.now();\n            document.getElementById('t1-ace-status').textContent = 'Processing...';\n\n            aceQuery(api, question, 't1', function(result) {\n                var t = Date.now() - aceStart;\n                console.log('[T1-ACE] SUCCESS - Completed in', t, 'ms');\n                console.log('[T1-ACE] Result data:', JSON.stringify(result.data));\n                console.log('[T1-ACE] Result reasoning:', result.reasoning);\n                \n                document.getElementById('t1-ace-time').textContent = Math.round(t / 1000) + 's';\n                debug('t1-debug', 'Ace: completed in ' + Math.round(t/1000) + 's');\n                debug('t1-debug', 'Ace data: ' + JSON.stringify(result.data));\n\n                var count = '--';\n                if (result.data && result.data[0]) {\n                    var keys = Object.keys(result.data[0]);\n                    count = result.data[0][keys[0]] || result.data.length;\n                    console.log('[T1-ACE] Extracted count:', count, 'from key:', keys[0]);\n                    debug('t1-debug', 'Extracted: ' + count + ' from key \"' + keys[0] + '\"');\n                }\n                document.getElementById('t1-ace-status').textContent = count + ' vehicles';\n                log('Test1 Ace: ' + count + ' vehicles in ' + Math.round(t / 1000) + 's');\n            }, function(e) {\n                console.error('[T1-ACE] ERROR:', e);\n                document.getElementById('t1-ace-status').textContent = 'Error';\n                debug('t1-debug', 'Ace ERROR: ' + e);\n            });\n        }\n\n        // Test 2: Freshness comparison - API part\n        function runTest2Api(api) {\n            console.log('[T2-API] Starting freshness test API call...');\n            document.getElementById('t2-api-result').textContent = 'Fetching...';\n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            \n            console.log('[T2-API] Current time:', now.toISOString());\n            console.log('[T2-API] Fetching trips from:', fromDate.toISOString());\n            debug('t2-debug', 'API: Fetching trips from ' + fromDate.toISOString());\n\n            api.call('Get', {\n                typeName: 'Trip',\n                search: {\n                    fromDate: fromDate.toISOString(),\n                    toDate: now.toISOString()\n                }\n            }, function(trips) {\n                console.log('[T2-API] SUCCESS - Got', trips.length, 'trips');\n                debug('t2-debug', 'API: Got ' + trips.length + ' trips');\n\n                if (trips && trips.length > 0) {\n                    trips.sort(function(a, b) {\n                        return new Date(b.stop) - new Date(a.stop);\n                    });\n                    var t = trips[0];\n                    var stopTime = new Date(t.stop);\n                    var ago = Math.round((now - stopTime) / (1000 * 60));\n                    var agoStr = ago < 60 ? ago + 'm ago' : Math.round(ago / 60) + 'h ago';\n\n                    console.log('[T2-API] Most recent trip stop:', t.stop);\n                    console.log('[T2-API] Device ID:', t.device.id);\n                    console.log('[T2-API] Time ago:', agoStr);\n                    \n                    debug('t2-debug', 'API: Most recent: ' + t.stop + ' (' + agoStr + ')');\n                    document.getElementById('t2-api-result').innerHTML =\n                        '<strong>' + agoStr + '</strong><br>' + stopTime.toLocaleString();\n                } else {\n                    console.log('[T2-API] No trips found in date range');\n                    document.getElementById('t2-api-result').textContent = 'No trips found';\n                    debug('t2-debug', 'API: No trips in last 30 days');\n                }\n                log('Test2 API: Got ' + trips.length + ' trips');\n            }, function(e) {\n                console.error('[T2-API] ERROR:', e);\n                document.getElementById('t2-api-result').textContent = 'Error';\n                debug('t2-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        // Test 2: Freshness comparison - Ace part\n        function runTest2Ace(api) {\n            var question = 'When was the most recent trip in my fleet? Give me the exact end time and vehicle name.';\n            console.log('[T2-ACE] Starting freshness test Ace query...');\n            console.log('[T2-ACE] Question:', question);\n            \n            document.getElementById('t2-ace-result').textContent = 'Processing...';\n            \n            aceQuery(api, question, 't2', function(res) {\n                console.log('[T2-ACE] SUCCESS');\n                console.log('[T2-ACE] Result data:', JSON.stringify(res.data));\n                console.log('[T2-ACE] Result reasoning:', res.reasoning);\n                \n                debug('t2-debug', 'Ace data: ' + JSON.stringify(res.data));\n\n                var aceText = '--';\n                if (res.data && res.data[0]) {\n                    aceText = JSON.stringify(res.data[0]);\n                    console.log('[T2-ACE] Showing data[0]:', aceText);\n                } else if (res.reasoning) {\n                    aceText = res.reasoning.substring(0, 80) + '...';\n                    console.log('[T2-ACE] No data, showing reasoning excerpt');\n                }\n                document.getElementById('t2-ace-result').innerHTML = aceText;\n                log('Test2 Ace: Got historical trip data');\n            }, function(e) {\n                console.error('[T2-ACE] ERROR:', e);\n                document.getElementById('t2-ace-result').textContent = 'Error';\n                debug('t2-debug', 'Ace ERROR: ' + e);\n            });\n        }\n\n        // Test 3: Complex analysis - API part\n        function runTest3Api(api) {\n            console.log('[T3-API] Starting complex analysis API call...');\n            var now = new Date();\n            var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n            \n            console.log('[T3-API] Fetching trips from:', monthStart.toISOString());\n            console.log('[T3-API] To:', now.toISOString());\n            debug('t3-debug', 'API: Fetching trips from ' + monthStart.toISOString());\n\n            var apiStart = Date.now();\n            document.getElementById('t3-api-status').textContent = 'Fetching trips...';\n\n            api.call('Get', {\n                typeName: 'Trip',\n                search: {\n                    fromDate: monthStart.toISOString(),\n                    toDate: now.toISOString()\n                }\n            }, function(trips) {\n                var apiTime = Date.now() - apiStart;\n                console.log('[T3-API] SUCCESS - Got', trips.length, 'trips in', apiTime, 'ms');\n                \n                document.getElementById('t3-api-time').textContent = apiTime + 'ms';\n                debug('t3-debug', 'API: ' + trips.length + ' trips in ' + apiTime + 'ms');\n\n                // Manual aggregation by device\n                console.log('[T3-API] Aggregating by device...');\n                var byDevice = {};\n                trips.forEach(function(trip) {\n                    var deviceId = trip.device.id;\n                    var dist = trip.distance || 0;\n                    if (!byDevice[deviceId]) {\n                        byDevice[deviceId] = { id: deviceId, distance: 0, trips: 0 };\n                    }\n                    byDevice[deviceId].distance += dist;\n                    byDevice[deviceId].trips++;\n                });\n\n                var sorted = Object.values(byDevice).sort(function(a, b) {\n                    return b.distance - a.distance;\n                });\n                var top3 = sorted.slice(0, 3);\n                \n                console.log('[T3-API] Aggregated to', sorted.length, 'devices');\n                console.log('[T3-API] Top 3:', JSON.stringify(top3));\n\n                result('t3-result', '=== API (you aggregate) ===');\n                result('t3-result', trips.length + ' trips -> ' + sorted.length + ' devices');\n                top3.forEach(function(d, i) {\n                    var miles = (d.distance / 1609.34).toFixed(1);\n                    result('t3-result', (i + 1) + '. ' + d.id + ': ' + miles + ' mi (' + d.trips + ' trips)');\n                });\n\n                document.getElementById('t3-api-status').textContent = trips.length + ' trips, ' + sorted.length + ' devices';\n                log('Test3 API: ' + trips.length + ' trips in ' + apiTime + 'ms');\n            }, function(e) {\n                console.error('[T3-API] ERROR:', e);\n                document.getElementById('t3-api-status').textContent = 'Error';\n                debug('t3-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        // Test 3: Complex analysis - Ace part\n        function runTest3Ace(api) {\n            var question = 'What are the top 3 vehicles by total distance traveled this month? Show vehicle name and distance in miles.';\n            console.log('[T3-ACE] Starting complex analysis Ace query...');\n            console.log('[T3-ACE] Question:', question);\n            \n            var aceStart = Date.now();\n            document.getElementById('t3-ace-status').textContent = 'Analyzing...';\n\n            aceQuery(api, question, 't3', function(res) {\n                var aceTime = Date.now() - aceStart;\n                console.log('[T3-ACE] SUCCESS - Completed in', aceTime, 'ms');\n                console.log('[T3-ACE] Result data:', JSON.stringify(res.data));\n                console.log('[T3-ACE] Result reasoning:', res.reasoning);\n                \n                document.getElementById('t3-ace-time').textContent = Math.round(aceTime / 1000) + 's';\n                debug('t3-debug', 'Ace: completed in ' + Math.round(aceTime/1000) + 's');\n\n                result('t3-result', '');\n                result('t3-result', '=== ACE (pre-analyzed) ===');\n\n                if (res.data && res.data.length > 0) {\n                    console.log('[T3-ACE] Got', res.data.length, 'rows of data');\n                    res.data.forEach(function(row, i) {\n                        result('t3-result', (i + 1) + '. ' + JSON.stringify(row));\n                    });\n                } else {\n                    console.log('[T3-ACE] No data array returned');\n                    result('t3-result', 'No data returned');\n                }\n\n                if (res.reasoning) {\n                    result('t3-result', '');\n                    result('t3-result', 'Reasoning: ' + res.reasoning.substring(0, 200) + '...');\n                }\n\n                document.getElementById('t3-ace-status').textContent = 'Done';\n                log('Test3 Ace: completed in ' + Math.round(aceTime / 1000) + 's');\n            }, function(e) {\n                console.error('[T3-ACE] ERROR:', e);\n                document.getElementById('t3-ace-status').textContent = 'Error';\n                debug('t3-debug', 'Ace ERROR: ' + e);\n                result('t3-result', 'Ace error: ' + e);\n            });\n        }\n\n        // Ace query helper with create-chat -> send-prompt -> poll pattern\n        function aceQuery(api, question, testId, onSuccess, onError) {\n            console.log('[ACE-QUERY] Starting query for', testId);\n            console.log('[ACE-QUERY] Question:', question);\n            log('Ace [' + testId + ']: \"' + question.substring(0, 50) + '...\"');\n\n            // Step 1: Create chat\n            console.log('[ACE-QUERY] Step 1: Creating chat...');\n            api.call('GetAceResults', {\n                serviceName: 'dna-planet-orchestration',\n                functionName: 'create-chat',\n                functionParameters: {}\n            }, function(r) {\n                console.log('[ACE-QUERY] create-chat response:', JSON.stringify(r).substring(0, 500));\n                var d = getAceData(r);\n                var chatId = d.chat_id;\n\n                if (!chatId) {\n                    console.error('[ACE-QUERY] No chat_id in response!');\n                    console.error('[ACE-QUERY] Full response:', JSON.stringify(r));\n                    onError('No chat_id in response');\n                    return;\n                }\n                console.log('[ACE-QUERY] Got chat_id:', chatId);\n                log('Ace [' + testId + ']: chat_id=' + chatId.substring(0, 8) + '...');\n\n                // Step 2: Send prompt\n                console.log('[ACE-QUERY] Step 2: Sending prompt...');\n                console.log('[ACE-QUERY] Prompt:', question);\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'send-prompt',\n                    functionParameters: {\n                        chat_id: chatId,\n                        prompt: question\n                    }\n                }, function(r2) {\n                    console.log('[ACE-QUERY] send-prompt response:', JSON.stringify(r2).substring(0, 500));\n                    var d2 = getAceData(r2);\n                    var mgId = d2.message_group_id || ((d2.message_group || {}).id);\n\n                    if (!mgId) {\n                        console.error('[ACE-QUERY] No message_group_id in response!');\n                        console.error('[ACE-QUERY] Full response:', JSON.stringify(r2));\n                        onError('No message_group_id');\n                        return;\n                    }\n                    console.log('[ACE-QUERY] Got message_group_id:', mgId);\n                    log('Ace [' + testId + ']: message_group_id=' + mgId.substring(0, 8) + '...');\n\n                    // Step 3: Poll after initial delay\n                    console.log('[ACE-QUERY] Step 3: Waiting', ACE_INITIAL_POLL_DELAY, 'ms before first poll...');\n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, 0);\n                    }, ACE_INITIAL_POLL_DELAY);\n                }, function(e) {\n                    console.error('[ACE-QUERY] send-prompt FAILED:', e);\n                    onError('send-prompt failed: ' + JSON.stringify(e));\n                });\n            }, function(e) {\n                console.error('[ACE-QUERY] create-chat FAILED:', e);\n                onError('create-chat failed: ' + JSON.stringify(e));\n            });\n        }\n\n        // Poll for Ace results\n        function pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt) {\n            console.log('[POLL] Attempt', attempt + 1, 'for', testId);\n            console.log('[POLL] chat_id:', chatId);\n            console.log('[POLL] message_group_id:', mgId);\n            \n            if (attempt >= ACE_MAX_POLL_ATTEMPTS) {\n                console.error('[POLL] Max attempts reached!');\n                onError('Timeout after ' + attempt + ' attempts');\n                return;\n            }\n\n            log('Ace [' + testId + ']: polling #' + (attempt + 1) + '...');\n\n            api.call('GetAceResults', {\n                serviceName: 'dna-planet-orchestration',\n                functionName: 'get-message-group',\n                functionParameters: {\n                    chat_id: chatId,\n                    message_group_id: mgId\n                }\n            }, function(r) {\n                console.log('[POLL] get-message-group response:', JSON.stringify(r).substring(0, 800));\n                var d = getAceData(r);\n                var mg = d.message_group || {};\n                var st = mg.status ? mg.status.status : 'UNKNOWN';\n\n                console.log('[POLL] Status:', st);\n                log('Ace [' + testId + ']: status=' + st);\n\n                if (st === 'DONE') {\n                    console.log('[POLL] Query complete!');\n                    var msgs = mg.messages || {};\n                    var res = { data: null, reasoning: null };\n                    var msgKeys = Object.keys(msgs);\n\n                    console.log('[POLL] Found', msgKeys.length, 'messages');\n                    console.log('[POLL] Message keys:', msgKeys);\n\n                    msgKeys.forEach(function(k) {\n                        var m = msgs[k];\n                        console.log('[POLL] Message', k, 'type:', m.type, 'has preview_array:', !!m.preview_array, 'has reasoning:', !!m.reasoning);\n                        if (m.preview_array) {\n                            res.data = m.preview_array;\n                            console.log('[POLL] Found preview_array with', res.data.length, 'items');\n                            console.log('[POLL] preview_array sample:', JSON.stringify(res.data).substring(0, 300));\n                        }\n                        if (m.reasoning) {\n                            res.reasoning = m.reasoning;\n                            console.log('[POLL] Found reasoning:', res.reasoning.substring(0, 200));\n                        }\n                    });\n\n                    onSuccess(res);\n                } else if (st === 'FAILED') {\n                    var errMsg = mg.status.message || 'Unknown failure';\n                    console.error('[POLL] Query FAILED:', errMsg);\n                    onError('Query FAILED: ' + errMsg);\n                } else {\n                    console.log('[POLL] Not done yet, will retry in', ACE_POLL_INTERVAL, 'ms');\n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                    }, ACE_POLL_INTERVAL);\n                }\n            }, function(e) {\n                console.error('[POLL] Poll error:', e);\n                console.log('[POLL] Will retry in', ACE_POLL_INTERVAL, 'ms');\n                log('Ace [' + testId + ']: poll error, retrying...');\n                setTimeout(function() {\n                    pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                }, ACE_POLL_INTERVAL);\n            });\n        }\n\n        console.log('Ace vs API Comparison v1.4 script loaded');\n        console.log('Waiting for Geotab Add-In initialization...');\n    </script>\n</body>\n</html>\n"
  }
}
