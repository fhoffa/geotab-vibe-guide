{
  "name": "Exception Heatmap Dashboard",
  "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide",
  "version": "2.0",
  "items": [
    {
      "url": "page.html",
      "path": "ActivityLink",
      "menuName": {
        "en": "Heatmap Insights"
      }
    }
  ],
  "files": {
    "page.html": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset='utf-8'>\n  <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js'></script>\n  <script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>\n  <script src='https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js'></script>\n  <script>\n    var link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css';\n    document.head.appendChild(link);\n\n    var mapLink = document.createElement('link');\n    mapLink.rel = 'stylesheet';\n    mapLink.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';\n    document.head.appendChild(mapLink);\n  </script>\n</head>\n<body style='background:#f4f7f9; padding:20px;'>\n\n  <div class='container-fluid'>\n    <div class='row mb-4 bg-white p-3 shadow-sm' style='border-radius:8px;'>\n      <div class='col-md-8'>\n        <h3>Fleet Exception Heatmap</h3>\n        <p class='text-muted' id='status-text'>Loading real data...</p>\n      </div>\n      <div class='col-md-4 d-flex align-items-center justify-content-end'>\n        <select id='dayRange' class='form-select me-2' style='width:auto;'>\n          <option value='1'>Last 24 hours</option>\n          <option value='3'>Last 3 days</option>\n          <option value='7' selected>Last 7 days</option>\n          <option value='14'>Last 14 days</option>\n        </select>\n        <button id='refreshBtn' class='btn btn-danger'>Refresh</button>\n      </div>\n    </div>\n\n    <div id='map' style='height: 500px; width: 100%; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);'></div>\n\n    <div class='row'>\n      <div class='col-md-12'>\n        <div class='card shadow-sm p-3'>\n          <canvas id='exceptionChart' style='max-height: 200px;'></canvas>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div id='debug-toggle' style='position:fixed;bottom:0;left:0;right:0;text-align:center;'>\n    <button onclick='var d=document.getElementById(\"debug-log\");d.style.display=d.style.display===\"none\"?\"block\":\"none\";' style='background:#e74c3c;color:#fff;border:none;padding:4px 16px;cursor:pointer;font-size:12px;border-radius:4px 4px 0 0;'>Toggle Debug Log</button>\n    <pre id='debug-log' style='display:block;background:#1e1e1e;color:#0f0;padding:10px;margin:0;max-height:300px;overflow-y:auto;text-align:left;font-size:11px;'></pre>\n  </div>\n\n  <script>\n    // Debug logger \u2014 visible in the on-page panel\n    function dbg(msg) {\n      var el = document.getElementById('debug-log');\n      if (el) {\n        var ts = new Date().toISOString().substring(11, 23);\n        el.textContent += '[' + ts + '] ' + msg + '\\n';\n        el.scrollTop = el.scrollHeight;\n      }\n      console.log('[heatmap] ' + msg);\n    }\n\n    geotab.addin[\"exception-heatmap\"] = function() {\n      var map, chart, heatLayer, apiRef;\n\n      // \u2500\u2500 Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n      // Wrap api.call in a Promise for cleaner sequencing\n      function apiGet(typeName, search) {\n        return new Promise(function(resolve, reject) {\n          dbg('API call: Get ' + typeName + ' \u2014 search: ' + JSON.stringify(search));\n          apiRef.call('Get', {\n            typeName: typeName,\n            search: search || {}\n          }, function(result) {\n            dbg('  \u2713 ' + typeName + ' returned ' + (result ? result.length : 0) + ' records');\n            resolve(result || []);\n          }, function(err) {\n            dbg('  \u2717 ' + typeName + ' ERROR: ' + err);\n            reject(err);\n          });\n        });\n      }\n\n      function apiMultiCall(calls) {\n        return new Promise(function(resolve, reject) {\n          dbg('API multiCall: ' + calls.length + ' calls');\n          apiRef.multiCall(calls, function(results) {\n            dbg('  \u2713 multiCall returned ' + results.length + ' result sets');\n            resolve(results);\n          }, function(err) {\n            dbg('  \u2717 multiCall ERROR: ' + err);\n            reject(err);\n          });\n        });\n      }\n\n      // \u2500\u2500 Main data fetch \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n      function loadData() {\n        var days = parseInt(document.getElementById('dayRange').value, 10);\n        var fromDate = new Date();\n        fromDate.setDate(fromDate.getDate() - days);\n        var toDate = new Date();\n\n        dbg('\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550');\n        dbg('Starting data load \u2014 last ' + days + ' days');\n        dbg('From: ' + fromDate.toISOString());\n        dbg('To:   ' + toDate.toISOString());\n        document.getElementById('status-text').textContent = 'Fetching exceptions\u2026';\n\n        // Step 1: Fetch ExceptionEvents + Rules in parallel\n        Promise.all([\n          apiGet('ExceptionEvent', {\n            fromDate: fromDate.toISOString(),\n            toDate: toDate.toISOString()\n          }),\n          apiGet('Rule')\n        ]).then(function(results) {\n          var exceptions = results[0];\n          var rules = results[1];\n\n          dbg('\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500');\n          dbg('Exceptions received: ' + exceptions.length);\n          dbg('Rules received: ' + rules.length);\n\n          // Build a rule-name lookup\n          var ruleNames = {};\n          rules.forEach(function(r) {\n            ruleNames[r.id] = r.name || r.id;\n          });\n          dbg('Rule name map built (' + Object.keys(ruleNames).length + ' entries)');\n\n          // Log first 5 exceptions for debugging\n          exceptions.slice(0, 5).forEach(function(ex, i) {\n            dbg('  Exception[' + i + ']: rule=' + (ex.rule ? ex.rule.id : 'N/A') +\n                ' device=' + (ex.device ? ex.device.id : 'N/A') +\n                ' from=' + ex.activeFrom +\n                ' to=' + (ex.activeTo || 'ongoing'));\n          });\n          if (exceptions.length > 5) {\n            dbg('  \u2026 and ' + (exceptions.length - 5) + ' more');\n          }\n\n          if (exceptions.length === 0) {\n            dbg('\u26a0 No exceptions found. Try a wider date range.');\n            document.getElementById('status-text').textContent =\n              'No exceptions found for the last ' + days + ' days.';\n            updateChart({});\n            if (heatLayer) map.removeLayer(heatLayer);\n            return;\n          }\n\n          // Step 2: For each exception, fetch the nearest LogRecord to get GPS\n          return fetchGPSForExceptions(exceptions, ruleNames);\n        }).catch(function(err) {\n          dbg('FATAL ERROR: ' + err);\n          document.getElementById('status-text').textContent = 'Error: ' + err;\n        });\n      }\n\n      // \u2500\u2500 GPS lookup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n      function fetchGPSForExceptions(exceptions, ruleNames) {\n        // Cap at 200 exceptions to avoid massive multiCall\n        var capped = exceptions.slice(0, 200);\n        dbg('Will fetch GPS for ' + capped.length + ' exceptions (capped at 200)');\n\n        // Build multiCall: for each exception, get LogRecords for that device\n        // in a \u00b160-second window around activeFrom\n        var calls = [];\n        capped.forEach(function(ex) {\n          var start = new Date(ex.activeFrom);\n          var end = new Date(ex.activeTo || ex.activeFrom);\n          // Widen window: 60s before start, 60s after end\n          start.setSeconds(start.getSeconds() - 60);\n          end.setSeconds(end.getSeconds() + 60);\n\n          calls.push(['Get', {\n            typeName: 'LogRecord',\n            search: {\n              deviceSearch: { id: ex.device.id },\n              fromDate: start.toISOString(),\n              toDate: end.toISOString()\n            }\n          }]);\n        });\n\n        // multiCall in batches of 50 to avoid payload limits\n        var batchSize = 50;\n        var batches = [];\n        for (var i = 0; i < calls.length; i += batchSize) {\n          batches.push(calls.slice(i, i + batchSize));\n        }\n        dbg('Batched into ' + batches.length + ' multiCall(s) of up to ' + batchSize);\n\n        // Execute batches sequentially\n        var allLogResults = [];\n        var chain = Promise.resolve();\n        batches.forEach(function(batch, batchIdx) {\n          chain = chain.then(function() {\n            dbg('Sending batch ' + (batchIdx + 1) + '/' + batches.length + ' (' + batch.length + ' calls)');\n            return apiMultiCall(batch);\n          }).then(function(batchResults) {\n            allLogResults = allLogResults.concat(batchResults);\n          });\n        });\n\n        return chain.then(function() {\n          dbg('\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500');\n          dbg('All GPS batches complete. Processing results\u2026');\n\n          var heatPoints = [];\n          var counts = {};\n          var matched = 0;\n          var unmatched = 0;\n\n          capped.forEach(function(ex, idx) {\n            var logs = allLogResults[idx] || [];\n            var ruleId = ex.rule ? ex.rule.id : 'Unknown';\n            var ruleName = ruleNames[ruleId] || ruleId;\n\n            // Count by rule name\n            counts[ruleName] = (counts[ruleName] || 0) + 1;\n\n            if (logs.length === 0) {\n              unmatched++;\n              if (unmatched <= 10) {\n                dbg('  No GPS for exception ' + idx + ' (device=' + ex.device.id +\n                    ' rule=' + ruleId + ' at ' + ex.activeFrom + ')');\n              }\n              return;\n            }\n\n            // Pick the LogRecord closest to activeFrom\n            var targetTime = new Date(ex.activeFrom).getTime();\n            var best = logs[0];\n            var bestDelta = Math.abs(new Date(best.dateTime).getTime() - targetTime);\n            for (var j = 1; j < logs.length; j++) {\n              var delta = Math.abs(new Date(logs[j].dateTime).getTime() - targetTime);\n              if (delta < bestDelta) {\n                best = logs[j];\n                bestDelta = delta;\n              }\n            }\n\n            // Skip invalid GPS (0,0 means no fix)\n            if (best.latitude === 0 && best.longitude === 0) {\n              unmatched++;\n              return;\n            }\n\n            heatPoints.push([best.latitude, best.longitude, 0.6]);\n            matched++;\n          });\n\n          dbg('\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500');\n          dbg('Results: ' + matched + ' with GPS, ' + unmatched + ' without GPS');\n          dbg('Rule breakdown:');\n          Object.keys(counts).forEach(function(name) {\n            dbg('  ' + name + ': ' + counts[name]);\n          });\n\n          document.getElementById('status-text').textContent =\n            matched + ' exceptions plotted (' + unmatched + ' had no GPS) \u2014 ' +\n            capped.length + ' of ' + exceptions.length + ' total';\n\n          // Update map\n          if (heatLayer) map.removeLayer(heatLayer);\n          if (heatPoints.length > 0) {\n            heatLayer = L.heatLayer(heatPoints, {\n              radius: 25, blur: 15, maxZoom: 12,\n              gradient: {0.2: 'blue', 0.4: 'lime', 0.6: 'yellow', 0.8: 'orange', 1: 'red'}\n            }).addTo(map);\n\n            // Auto-fit map to data bounds\n            var lats = heatPoints.map(function(p) { return p[0]; });\n            var lngs = heatPoints.map(function(p) { return p[1]; });\n            var bounds = [\n              [Math.min.apply(null, lats), Math.min.apply(null, lngs)],\n              [Math.max.apply(null, lats), Math.max.apply(null, lngs)]\n            ];\n            dbg('Map bounds: ' + JSON.stringify(bounds));\n            map.fitBounds(bounds, { padding: [40, 40] });\n          } else {\n            dbg('\u26a0 No points to display on map');\n          }\n\n          // Update chart\n          updateChart(counts);\n        });\n      }\n\n      // \u2500\u2500 Chart \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n      function updateChart(counts) {\n        if (chart) chart.destroy();\n        var labels = Object.keys(counts);\n        var data = labels.map(function(k) { return counts[k]; });\n\n        if (labels.length === 0) {\n          labels = ['No data'];\n          data = [0];\n        }\n\n        chart = new Chart(document.getElementById('exceptionChart'), {\n          type: 'bar',\n          data: {\n            labels: labels,\n            datasets: [{\n              label: 'Exceptions by Rule',\n              data: data,\n              backgroundColor: '#e74c3c'\n            }]\n          },\n          options: {\n            indexAxis: 'y',\n            plugins: { legend: { display: false } }\n          }\n        });\n      }\n\n      // \u2500\u2500 Lifecycle \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n      return {\n        initialize: function(api, state, callback) {\n          apiRef = api;\n          dbg('Add-in initialize called');\n\n          // Log session info\n          api.getSession(function(session) {\n            dbg('Session \u2014 user: ' + session.userName + ', db: ' + session.database);\n          });\n\n          map = L.map('map').setView([43.65, -79.38], 5);\n          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n            attribution: '\u00a9 OpenStreetMap'\n          }).addTo(map);\n\n          document.getElementById('refreshBtn').onclick = loadData;\n          document.getElementById('dayRange').onchange = loadData;\n\n          loadData();\n          callback();\n        },\n        focus: function(api, state) {\n          apiRef = api;\n          dbg('focus() called');\n          // Refresh map size in case container resized\n          if (map) setTimeout(function() { map.invalidateSize(); }, 200);\n        },\n        blur: function() {\n          dbg('blur() called');\n        }\n      };\n    };\n  </script>\n</body>\n</html>\n"
  }
}