<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Ace vs API Comparison</title>
    <style>
        body {
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #0f172a;
            margin-bottom: 4px;
        }
        .subtitle {
            color: #64748b;
            margin-top: 0;
            margin-bottom: 24px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }
        .card {
            background: #fff;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 12px;
        }
        .card-header h3 {
            margin: 0;
            font-size: 14px;
            color: #0f172a;
        }
        .card-header p {
            margin: 0;
            font-size: 11px;
            color: #64748b;
        }
        .emoji {
            font-size: 20px;
        }
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .api-result {
            background: #f0fdf4;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #bbf7d0;
        }
        .api-result .label {
            font-size: 10px;
            color: #166534;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .api-result .value {
            font-size: 18px;
            font-weight: bold;
            color: #15803d;
        }
        .api-result .status {
            font-size: 10px;
            color: #166534;
        }
        .ace-result {
            background: #fefce8;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #fef08a;
        }
        .ace-result .label {
            font-size: 10px;
            color: #a16207;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .ace-result .value {
            font-size: 18px;
            font-weight: bold;
            color: #ca8a04;
        }
        .ace-result .status {
            font-size: 10px;
            color: #a16207;
        }
        .question {
            margin-top: 10px;
            font-size: 12px;
            color: #334155;
            background: #f1f5f9;
            padding: 8px 10px;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }
        .question strong {
            color: #1e40af;
        }
        .debug {
            font-size: 9px;
            margin: 8px 0 0 0;
            background: #f1f5f9;
            padding: 6px;
            border-radius: 4px;
            overflow: auto;
            max-height: 80px;
            font-family: ui-monospace, monospace;
            white-space: pre-wrap;
        }
        .debug-ace {
            background: #fef3c7;
        }
        .log-section {
            margin-top: 20px;
            background: #fff;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .log-section h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #0f172a;
        }
        #log {
            background: #f8fafc;
            padding: 10px;
            border-radius: 6px;
            max-height: 150px;
            overflow: auto;
            font-size: 10px;
            font-family: ui-monospace, monospace;
            color: #475569;
        }
        .takeaways {
            margin-top: 16px;
            background: #eff6ff;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #bfdbfe;
        }
        .takeaways h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #1e40af;
        }
        .takeaways-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            font-size: 12px;
        }
        .takeaways strong.api {
            color: #15803d;
        }
        .takeaways strong.ace {
            color: #ca8a04;
        }
        .takeaways strong.when {
            color: #1e40af;
        }
        .takeaways ul {
            margin: 4px 0 0 0;
            padding-left: 16px;
            color: #475569;
        }
        #t3-result {
            max-height: 120px;
        }
        #t2-api-result, #t2-ace-result {
            font-size: 11px;
            word-break: break-word;
        }
        #t3-api-time, #t3-ace-time {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Ace vs Direct API Comparison v1.5</h1>
    <p class="subtitle">Three tests demonstrating when to use each approach</p>

    <div class="grid">
        <!-- Test 1: Speed -->
        <div class="card">
            <div class="card-header">
                <span class="emoji">1️⃣</span>
                <div>
                    <h3>Speed Test</h3>
                    <p>Same question, timing comparison</p>
                </div>
            </div>
            <div class="results-grid">
                <div class="api-result">
                    <div class="label">DIRECT API</div>
                    <div class="value" id="t1-api-time">--</div>
                    <div class="status" id="t1-api-status">Waiting...</div>
                </div>
                <div class="ace-result">
                    <div class="label">ACE AI</div>
                    <div class="value" id="t1-ace-time">--</div>
                    <div class="status" id="t1-ace-status">Waiting...</div>
                </div>
            </div>
            <div class="question"><strong>Q:</strong> "How many vehicles are in my fleet?"</div>
            <pre class="debug" id="t1-debug"></pre>
        </div>

        <!-- Test 2: Freshness -->
        <div class="card">
            <div class="card-header">
                <span class="emoji">2️⃣</span>
                <div>
                    <h3>Freshness Test</h3>
                    <p>Ace data can be hours behind</p>
                </div>
            </div>
            <div class="results-grid">
                <div class="api-result">
                    <div class="label">API (Real-time)</div>
                    <div id="t2-api-result">Waiting...</div>
                </div>
                <div class="ace-result">
                    <div class="label">ACE (Historical)</div>
                    <div id="t2-ace-result">Waiting...</div>
                </div>
            </div>
            <div class="question"><strong>Q:</strong> "When was the most recent trip? Give exact end time and vehicle name."</div>
            <pre class="debug" id="t2-debug"></pre>
        </div>

        <!-- Test 3: Complex Analysis -->
        <div class="card">
            <div class="card-header">
                <span class="emoji">3️⃣</span>
                <div>
                    <h3>Complex Analysis</h3>
                    <p>API gets raw data, Ace analyzes it</p>
                </div>
            </div>
            <div class="results-grid">
                <div class="api-result">
                    <div class="label">API (Raw Data)</div>
                    <div class="value" id="t3-api-time">--</div>
                    <div class="status" id="t3-api-status">Waiting...</div>
                </div>
                <div class="ace-result">
                    <div class="label">ACE (Analyzed)</div>
                    <div class="value" id="t3-ace-time">--</div>
                    <div class="status" id="t3-ace-status">Waiting...</div>
                </div>
            </div>
            <div class="question"><strong>Q:</strong> "Top 3 vehicles by total distance this month? (API: raw trips + manual aggregation)"</div>
            <pre class="debug" id="t3-result"></pre>
            <pre class="debug debug-ace" id="t3-debug"></pre>
        </div>
    </div>

    <div class="log-section">
        <h3>Activity Log</h3>
        <div id="log"></div>
    </div>

    <div class="takeaways">
        <h3>Key Takeaways</h3>
        <div class="takeaways-grid">
            <div>
                <strong class="api">Direct API</strong>
                <ul>
                    <li>~300-500ms response</li>
                    <li>Real-time data</li>
                    <li>Raw data only</li>
                </ul>
            </div>
            <div>
                <strong class="ace">Ace AI</strong>
                <ul>
                    <li>~30-90 sec response</li>
                    <li>2-24 hours behind</li>
                    <li>Analyzed results</li>
                </ul>
            </div>
            <div>
                <strong class="when">When to Use</strong>
                <ul>
                    <li>API: live data, writes</li>
                    <li>Ace: trends, insights</li>
                    <li>Test 3: API fast but YOU aggregate</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Logging utilities
        function log(m) {
            var d = document.getElementById('log');
            var t = new Date().toLocaleTimeString();
            d.innerHTML = '<div>[' + t + '] ' + m + '</div>' + d.innerHTML;
            console.log('[' + t + '] ' + m);
        }

        function debug(id, m) {
            var d = document.getElementById(id);
            if (d) d.textContent += m + '\n';
            console.log(id + ': ' + m);
        }

        function result(id, m) {
            var d = document.getElementById(id);
            if (d) d.textContent += m + '\n';
        }

        // Extract Ace data from nested response
        function getAceData(r) {
            if (r && r.apiResult && r.apiResult.results) {
                return r.apiResult.results[0] || {};
            }
            return r || {};
        }

        // Geotab Add-In registration
        geotab.addin['ace-api-comparison'] = function() {
            return {
                initialize: function(api, state, callback) {
                    log('Starting 3 comparison tests (Ace calls staggered)...');

                    // Run all API calls immediately (they're fast)
                    runTest1Api(api);
                    runTest2Api(api);
                    runTest3Api(api);

                    // Stagger Ace calls to avoid rate limiting
                    log('Starting Test1 Ace...');
                    runTest1Ace(api, function() {
                        log('Test1 Ace done, starting Test2 Ace in 2s...');
                        setTimeout(function() {
                            runTest2Ace(api, function() {
                                log('Test2 Ace done, starting Test3 Ace in 2s...');
                                setTimeout(function() {
                                    runTest3Ace(api);
                                }, 2000);
                            });
                        }, 2000);
                    });

                    callback();
                },
                focus: function() {},
                blur: function() {}
            };
        };

        // Test 1: Speed comparison - API part
        function runTest1Api(api) {
            var apiStart = Date.now();
            document.getElementById('t1-api-status').textContent = 'Fetching...';

            api.call('Get', { typeName: 'Device' }, function(devices) {
                var t = Date.now() - apiStart;
                document.getElementById('t1-api-time').textContent = t + 'ms';
                document.getElementById('t1-api-status').textContent = devices.length + ' vehicles';
                debug('t1-debug', 'API returned ' + devices.length + ' Device objects');
                log('Test1 API: ' + devices.length + ' devices in ' + t + 'ms');
            }, function(e) {
                document.getElementById('t1-api-status').textContent = 'Error';
                debug('t1-debug', 'API ERROR: ' + JSON.stringify(e));
            });
        }

        // Test 1: Speed comparison - Ace part
        function runTest1Ace(api, onComplete) {
            var aceStart = Date.now();
            document.getElementById('t1-ace-status').textContent = 'Processing...';

            aceQuery(api, 't1-debug', 'How many vehicles are in my fleet?', function(result) {
                var t = Date.now() - aceStart;
                document.getElementById('t1-ace-time').textContent = Math.round(t / 1000) + 's';
                debug('t1-debug', 'Ace result.data: ' + JSON.stringify(result.data));
                debug('t1-debug', 'Ace reasoning: ' + (result.reasoning || '').substring(0, 100));

                var count = '--';
                if (result.data && result.data[0]) {
                    var keys = Object.keys(result.data[0]);
                    count = result.data[0][keys[0]] || result.data.length;
                    debug('t1-debug', 'Extracted count: ' + count + ' from key: ' + keys[0]);
                }
                document.getElementById('t1-ace-status').textContent = count + ' vehicles';
                log('Test1 Ace: completed in ' + Math.round(t / 1000) + 's');
                if (onComplete) onComplete();
            }, function(e) {
                document.getElementById('t1-ace-status').textContent = 'Error';
                debug('t1-debug', 'Ace ERROR: ' + e);
                if (onComplete) onComplete();
            });
        }

        // Test 2: Freshness comparison - API part
        function runTest2Api(api) {
            document.getElementById('t2-api-result').textContent = 'Fetching...';
            var now = new Date();
            debug('t2-debug', 'Current time: ' + now.toISOString());

            api.call('Get', {
                typeName: 'Trip',
                search: {
                    fromDate: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                    toDate: now.toISOString()
                }
            }, function(trips) {
                debug('t2-debug', 'API returned ' + trips.length + ' trips total');

                if (trips && trips.length > 0) {
                    trips.sort(function(a, b) {
                        return new Date(b.stop) - new Date(a.stop);
                    });
                    var t = trips[0];
                    var stopTime = new Date(t.stop);
                    var ago = Math.round((now - stopTime) / (1000 * 60));
                    var agoStr = ago < 60 ? ago + 'm ago' : Math.round(ago / 60) + 'h ago';

                    debug('t2-debug', 'Most recent trip.stop: ' + t.stop);
                    debug('t2-debug', 'Device: ' + t.device.id + ', ago: ' + agoStr);
                    document.getElementById('t2-api-result').innerHTML =
                        '<strong>' + agoStr + '</strong><br>' + stopTime.toLocaleString();
                } else {
                    document.getElementById('t2-api-result').textContent = 'No trips found';
                    debug('t2-debug', 'No trips in last 30 days');
                }
                log('Test2 API: Got trips');
            }, function(e) {
                document.getElementById('t2-api-result').textContent = 'Error';
                debug('t2-debug', 'API ERROR: ' + JSON.stringify(e));
            });
        }

        // Test 2: Freshness comparison - Ace part
        function runTest2Ace(api, onComplete) {
            document.getElementById('t2-ace-result').textContent = 'Processing...';
            aceQuery(api, 't2-debug', 'When was the most recent trip in my fleet? Give me the exact end time and vehicle name.', function(res) {
                debug('t2-debug', 'Ace result.data: ' + JSON.stringify(res.data));
                debug('t2-debug', 'Ace reasoning: ' + (res.reasoning || '').substring(0, 150));

                var aceText = '--';
                if (res.data && res.data[0]) {
                    aceText = JSON.stringify(res.data[0]);
                } else if (res.reasoning) {
                    aceText = res.reasoning.substring(0, 80) + '...';
                }
                document.getElementById('t2-ace-result').innerHTML = aceText;
                log('Test2 Ace: Got historical trip data');
                if (onComplete) onComplete();
            }, function(e) {
                document.getElementById('t2-ace-result').textContent = 'Error';
                debug('t2-debug', 'Ace ERROR: ' + e);
                if (onComplete) onComplete();
            });
        }

        // Test 3: Complex analysis comparison - API part
        function runTest3Api(api) {
            var now = new Date();
            var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            debug('t3-debug', 'Fetching trips from ' + monthStart.toISOString());

            var apiStart = Date.now();
            document.getElementById('t3-api-status').textContent = 'Fetching trips...';

            api.call('Get', {
                typeName: 'Trip',
                search: {
                    fromDate: monthStart.toISOString(),
                    toDate: now.toISOString()
                }
            }, function(trips) {
                var apiTime = Date.now() - apiStart;
                document.getElementById('t3-api-time').textContent = apiTime + 'ms';
                debug('t3-debug', 'API got ' + trips.length + ' trips in ' + apiTime + 'ms');

                // Manual aggregation by device
                var byDevice = {};
                trips.forEach(function(trip) {
                    var deviceId = trip.device.id;
                    var dist = trip.distance || 0;
                    if (!byDevice[deviceId]) {
                        byDevice[deviceId] = { id: deviceId, distance: 0, trips: 0 };
                    }
                    byDevice[deviceId].distance += dist;
                    byDevice[deviceId].trips++;
                });

                var sorted = Object.values(byDevice).sort(function(a, b) {
                    return b.distance - a.distance;
                });
                var top3 = sorted.slice(0, 3);

                result('t3-result', '=== API (you aggregate) ===');
                result('t3-result', 'Got ' + trips.length + ' trips, aggregated to ' + sorted.length + ' devices');
                top3.forEach(function(d, i) {
                    var miles = (d.distance / 1609.34).toFixed(1);
                    result('t3-result', (i + 1) + '. Device ' + d.id + ': ' + miles + ' mi (' + d.trips + ' trips)');
                });

                document.getElementById('t3-api-status').textContent = trips.length + ' trips, ' + sorted.length + ' devices';
                log('Test3 API: ' + trips.length + ' trips in ' + apiTime + 'ms');
            }, function(e) {
                document.getElementById('t3-api-status').textContent = 'Error';
                debug('t3-debug', 'API ERROR: ' + JSON.stringify(e));
            });
        }

        // Test 3: Complex analysis comparison - Ace part
        function runTest3Ace(api, onComplete) {
            var aceStart = Date.now();
            document.getElementById('t3-ace-status').textContent = 'Analyzing...';

            aceQuery(api, 't3-debug', 'What are the top 3 vehicles by total distance traveled this month? Show vehicle name and distance in miles.', function(res) {
                var aceTime = Date.now() - aceStart;
                document.getElementById('t3-ace-time').textContent = Math.round(aceTime / 1000) + 's';
                debug('t3-debug', 'Ace completed in ' + aceTime + 'ms');

                result('t3-result', '');
                result('t3-result', '=== ACE (pre-analyzed) ===');

                if (res.data && res.data.length > 0) {
                    res.data.forEach(function(row, i) {
                        result('t3-result', (i + 1) + '. ' + JSON.stringify(row));
                    });
                } else {
                    result('t3-result', 'No data returned');
                }

                if (res.reasoning) {
                    result('t3-result', '');
                    result('t3-result', 'Reasoning: ' + res.reasoning.substring(0, 200) + '...');
                }

                document.getElementById('t3-ace-status').textContent = 'Done';
                log('Test3 Ace: completed in ' + Math.round(aceTime / 1000) + 's');
                if (onComplete) onComplete();
            }, function(e) {
                document.getElementById('t3-ace-status').textContent = 'Error';
                debug('t3-debug', 'Ace ERROR: ' + e);
                result('t3-result', 'Ace error: ' + e);
                if (onComplete) onComplete();
            });
        }

        // Ace query helper with create-chat → send-prompt → poll pattern
        // debugId: element ID to write debug info to
        function aceQuery(api, debugId, question, onSuccess, onError) {
            log('Ace query: ' + question.substring(0, 40) + '...');
            debug(debugId, 'Starting Ace query...');

            // Step 1: Create chat
            debug(debugId, 'Calling create-chat...');
            api.call('GetAceResults', {
                serviceName: 'dna-planet-orchestration',
                functionName: 'create-chat',
                functionParameters: {}
            }, function(r) {
                debug(debugId, 'create-chat raw response type: ' + typeof r);
                debug(debugId, 'create-chat raw: ' + JSON.stringify(r).substring(0, 300));

                var d = getAceData(r);
                debug(debugId, 'create-chat parsed: ' + JSON.stringify(d).substring(0, 200));

                var chatId = d.chat_id;
                if (!chatId) {
                    debug(debugId, 'ERROR: No chat_id found in response');
                    debug(debugId, 'Response keys: ' + Object.keys(d || {}).join(', '));
                    onError('No chat_id in response. Keys: ' + Object.keys(d || {}).join(', '));
                    return;
                }
                debug(debugId, 'Got chat_id: ' + chatId);
                log('Got chat_id: ' + chatId.substring(0, 8) + '...');

                // Step 2: Send prompt
                debug(debugId, 'Calling send-prompt...');
                api.call('GetAceResults', {
                    serviceName: 'dna-planet-orchestration',
                    functionName: 'send-prompt',
                    functionParameters: {
                        chat_id: chatId,
                        prompt: question
                    }
                }, function(r2) {
                    debug(debugId, 'send-prompt raw: ' + JSON.stringify(r2).substring(0, 300));

                    var d2 = getAceData(r2);
                    debug(debugId, 'send-prompt parsed: ' + JSON.stringify(d2).substring(0, 200));

                    // Handle both flat and nested message_group_id
                    var mgId = d2.message_group_id || ((d2.message_group || {}).id);
                    debug(debugId, 'message_group_id: ' + mgId);

                    if (!mgId) {
                        debug(debugId, 'ERROR: No message_group_id found');
                        debug(debugId, 'Response keys: ' + Object.keys(d2 || {}).join(', '));
                        onError('No message_group_id. Keys: ' + Object.keys(d2 || {}).join(', '));
                        return;
                    }
                    log('Got message_group_id, waiting 10s...');

                    // Step 3: Poll after initial delay
                    setTimeout(function() {
                        pollAce(api, debugId, chatId, mgId, onSuccess, onError, 0);
                    }, 10000);
                }, function(e) {
                    debug(debugId, 'send-prompt ERROR: ' + JSON.stringify(e));
                    onError('send-prompt failed: ' + JSON.stringify(e));
                });
            }, function(e) {
                debug(debugId, 'create-chat ERROR: ' + JSON.stringify(e));
                onError('create-chat failed: ' + JSON.stringify(e));
            });
        }

        // Poll for Ace results
        function pollAce(api, debugId, chatId, mgId, onSuccess, onError, attempt) {
            if (attempt > 15) {
                debug(debugId, 'TIMEOUT after ' + attempt + ' attempts');
                onError('Timeout after ' + attempt + ' attempts');
                return;
            }

            log('Polling attempt ' + (attempt + 1) + '...');

            api.call('GetAceResults', {
                serviceName: 'dna-planet-orchestration',
                functionName: 'get-message-group',
                functionParameters: {
                    chat_id: chatId,
                    message_group_id: mgId
                }
            }, function(r) {
                var d = getAceData(r);
                var mg = d.message_group || {};
                var st = mg.status ? mg.status.status : 'UNKNOWN';

                debug(debugId, 'Poll #' + (attempt + 1) + ' status: ' + st);
                log('Poll status: ' + st);

                if (st === 'DONE') {
                    var msgs = mg.messages || {};
                    var res = { data: null, reasoning: null };
                    var msgKeys = Object.keys(msgs);

                    debug(debugId, 'DONE - Found ' + msgKeys.length + ' messages');
                    log('Found ' + msgKeys.length + ' messages');

                    msgKeys.forEach(function(k) {
                        var m = msgs[k];
                        debug(debugId, 'Message ' + k + ' keys: ' + Object.keys(m).join(', '));
                        if (m.preview_array) {
                            res.data = m.preview_array;
                            debug(debugId, 'preview_array has ' + res.data.length + ' items');
                            log('Found preview_array with ' + res.data.length + ' items');
                        }
                        if (m.reasoning) {
                            res.reasoning = m.reasoning;
                            debug(debugId, 'reasoning: ' + res.reasoning.substring(0, 100) + '...');
                        }
                    });

                    onSuccess(res);
                } else if (st === 'FAILED') {
                    var errMsg = mg.status.message || 'Unknown failure';
                    debug(debugId, 'FAILED: ' + errMsg);
                    onError('Query FAILED: ' + errMsg);
                } else {
                    setTimeout(function() {
                        pollAce(api, debugId, chatId, mgId, onSuccess, onError, attempt + 1);
                    }, 8000);
                }
            }, function(e) {
                debug(debugId, 'Poll error: ' + JSON.stringify(e));
                log('Poll error, retrying...');
                setTimeout(function() {
                    pollAce(api, debugId, chatId, mgId, onSuccess, onError, attempt + 1);
                }, 8000);
            });
        }

        console.log('Ace vs API Comparison v1.5 registered');
    </script>
</body>
</html>
